# üîç Diagn√≥stico Completo: household_members Vac√≠o en EditApplication

**Fecha:** 12 de Octubre, 2025  
**Problema:** Al editar una solicitud, `household_members` aparece vac√≠o `[]`  
**Impacto:** No se puede ver ni editar el jefe de familia ni otros miembros del hogar

---

## üìã Resumen Ejecutivo

El problema NO est√° en el backend guardando mal los datos, sino en **DOS DESCONEXIONES**:

1. **Backend guarda como `main_applicant`** pero **frontend busca `head_of_family`** en la respuesta
2. **Backend NO env√≠a `household_members`** al frontend en el DTO de respuesta (campo faltante)

---

## üîÑ Flujo de Datos Completo

### **1. CREAR Solicitud (NewApplication ‚Üí Backend ‚Üí MongoDB)**

#### **Frontend env√≠ a:**
```typescript
// NewApplication.tsx l√≠nea ~380
const requestData = {
  convocation_code: "CONV-001",
  user_data: {
    dni: "47649607",
    names: "JONATHAN",
    surnames: "ELIAS DELGADO",
    phone: "975332406",
    email: "asdasd@gmail.com"
  },
  head_of_family: {  // ‚úÖ Env√≠a como head_of_family
    document_number: "47649607",
    first_name: "JONATHAN",
    paternal_surname: "ELIAS",
    maternal_surname: "DELGADO",
    birth_date: "1990-01-01",
    civil_status: "soltero",
    education_level: "universitaria_completa",
    occupation: "Ingeniero",
    phone_number: "975332406",
    email: "asdasd@gmail.com"
  },
  head_of_family_economic: {
    employment_situation: "dependiente",
    monthly_income: 5000,
    work_condition: "formal"
  },
  household_members: [],  // ‚ùå FRONTEND FILTRA al jefe de familia (l√≠nea 351-358)
  property_info: {...}
}
```

#### **Backend procesa (create_application_use_case.py):**
```python
# L√≠neas 113-130
head_of_family = Applicant(  # ‚úÖ Recibe como head_of_family
    document_number=dto.head_of_family.document_number,
    first_name=dto.head_of_family.first_name,
    # ...
)

head_of_family_economic = EconomicInfo(
    employment_situation=dto.head_of_family_economic.employment_situation,
    # ...
)

# L√≠neas 195-214
household_members = []
for member_dto in dto.household_members:  # ‚ùå Lista vac√≠a porque frontend filtr√≥
    member = HouseholdMember(...)
    household_members.append(member)

# L√≠nea 220
application = TechoPropioApplication(
    head_of_family=head_of_family,  # ‚úÖ Asigna correctamente
    head_of_family_economic=head_of_family_economic,
    household_members=household_members,  # ‚ùå Lista vac√≠a []
    # ...
)
```

#### **Backend guarda en MongoDB (application_mapper.py):**
```python
# L√≠neas 40-41
document = {
    "main_applicant": ApplicantMapper.to_dict(application.head_of_family),  # ‚ùå Guarda como main_applicant
    "main_applicant_economic": EconomicMapper.to_dict(application.head_of_family_economic),
    "household_members": [...]  # ‚ùå Lista vac√≠a
}
```

#### **MongoDB tiene:**
```json
{
  "_id": "68ec37761afb62c361c3fc22",
  "main_applicant": {  // ‚ùå Nombre antiguo
    "document_number": "47649607",
    "first_name": "JONATHAN",
    "paternal_surname": "ELIAS",
    "maternal_surname": "DELGADO",
    "birth_date": "1990-01-01",
    "civil_status": "soltero",
    "education_level": "universitaria_completa",
    "occupation": "Ingeniero"
  },
  "main_applicant_economic": {
    "employment_situation": "dependiente",
    "monthly_income": 5000,
    "work_condition": "formal"
  },
  "household_members": [],  // ‚ùå VAC√çO
  "status": "draft",
  "user_id": "user_339MX93RuwYOONURelR2HCxBrDU"
}
```

---

### **2. EDITAR Solicitud (EditApplication ‚Üê Backend ‚Üê MongoDB)**

#### **Backend lee de MongoDB (application_mapper.py):**
```python
# L√≠neas 80-93
@classmethod
def from_dict(cls, document: Dict[str, Any]) -> TechoPropioApplication:
    # Lee main_applicant de MongoDB
    head_of_family = ApplicantMapper.from_dict(document["main_applicant"])  # ‚úÖ Convierte correctamente
    property_info = PropertyMapper.from_dict(document["property_info"])
    head_of_family_economic = EconomicMapper.from_dict(document["main_applicant_economic"])
    
    application = TechoPropioApplication(
        head_of_family=head_of_family,  # ‚úÖ Asigna correctamente como head_of_family
        property_info=property_info,
        head_of_family_economic=head_of_family_economic
    )
    
    application.id = str(document["_id"])
    application.user_id = document.get("user_id")
    application.status = ApplicationStatus(document["status"])
    
    # ‚ùå FALTA: Restaurar household_members desde document["household_members"]
```

#### **Backend responde (create_application_use_case._convert_to_response_dto):**
```python
# L√≠neas 250-290
head_of_family_dto = ApplicantResponseDTO(
    id=application.head_of_family.id,
    document_number=application.head_of_family.document_number,
    first_name=application.head_of_family.first_name,
    # ... ‚úÖ Todos los campos del jefe de familia
)

# L√≠neas 397-415
household_dtos = []
for member in application.household_members:  # ‚ùå Lista vac√≠a porque no se restaur√≥
    member_dto = HouseholdMemberResponseDTO(...)
    household_dtos.append(member_dto)

# L√≠neas 430-445
response_dto = TechoPropioApplicationResponseDTO(
    id=application.id,
    head_of_family=head_of_family_dto,  # ‚úÖ Env√≠a head_of_family
    head_of_family_economic=head_of_family_economic_dto,
    household_members=household_dtos,  # ‚ùå Lista vac√≠a []
    # ...
)
```

#### **Frontend recibe (TechoPropioApplication interface):**
```typescript
// application.types.ts l√≠nea 268
export interface TechoPropioApplication {
  id?: string;
  code: string;
  status: ApplicationStatus;
  applicant: Applicant;  // ‚ùå Frontend espera "applicant", backend env√≠a "head_of_family"
  household_members: HouseholdMember[];  // ‚ùå Recibe lista vac√≠a []
  economic_info: EconomicInfo;
  property_info: PropertyInfo;
  // ...
}
```

#### **EditApplication mapea (l√≠neas 38-90):**
```typescript
useEffect(() => {
  if (selectedApplication) {
    console.log('üîç selectedApplication:', selectedApplication);
    
    // Busca jefe de familia en household_members
    const realHeadOfFamily = selectedApplication.household_members?.find(
      member => member.member_type === 'JEFE_FAMILIA'
    );  // ‚ùå NO LO ENCUENTRA porque household_members est√° vac√≠o []
    
    console.log('üë®‚Äçüíº Jefe de Familia Real:', realHeadOfFamily);  // undefined
    
    const mappedData: ApplicationFormData = {
      head_of_family: {
        dni: selectedApplication.applicant?.dni || realHeadOfFamily?.dni || '',  // ‚ùå Ambos vac√≠os
        first_name: selectedApplication.applicant?.first_name || '',  // ‚ùå Vac√≠o
        // ...
      },
      household_members: selectedApplication.household_members || []  // ‚ùå []
    };
    
    console.log('üì¶ Mapped formData:', mappedData);
    setFormData(mappedData);
  }
}, [selectedApplication]);
```

---

## üéØ Problemas Identificados

### **Problema 1: Desconexi√≥n de Nomenclatura**

| Ubicaci√≥n | Nombre del Campo | Estado |
|-----------|------------------|--------|
| Frontend env√≠a | `head_of_family` | ‚úÖ Correcto |
| Backend procesa | `head_of_family` | ‚úÖ Correcto |
| MongoDB guarda | `main_applicant` | ‚ùå Nombre antiguo |
| Backend lee MongoDB | `main_applicant` ‚Üí `head_of_family` | ‚úÖ Convierte correctamente |
| Backend responde | `head_of_family` | ‚úÖ Correcto |
| Frontend espera | `applicant` | ‚ùå Nombre diferente |

**Consecuencia:**  
Frontend busca `selectedApplication.applicant` pero backend env√≠a `selectedApplication.head_of_family`

---

### **Problema 2: household_members No Se Restaura**

#### **En `application_mapper.py` l√≠neas 80-125:**

```python
@classmethod
def from_dict(cls, document: Dict[str, Any]) -> TechoPropioApplication:
    head_of_family = ApplicantMapper.from_dict(document["main_applicant"])
    property_info = PropertyMapper.from_dict(document["property_info"])
    head_of_family_economic = EconomicMapper.from_dict(document["main_applicant_economic"])
    
    application = TechoPropioApplication(
        head_of_family=head_of_family,
        property_info=property_info,
        head_of_family_economic=head_of_family_economic
        # ‚ùå FALTA: household_members NO se pasa al constructor
    )
    
    # ... asignaciones de metadata
    
    # ‚ùå FALTA: 
    # if "household_members" in document:
    #     application.household_members = [
    #         HouseholdMemberMapper.from_dict(m) for m in document["household_members"]
    #     ]
    
    return application
```

**Resultado:**  
`application.household_members` queda como lista vac√≠a `[]` incluso si MongoDB tiene datos.

---

### **Problema 3: Frontend Filtra el Jefe de Familia**

#### **En `NewApplication.tsx` l√≠neas 351-358:**

```typescript
// Transformar household_members: EXCLUIR jefe de familia para evitar DNI duplicado
const transformedHouseholdMembers = (formData.household_members || [])
  .filter(member => 
    // Filtrar el jefe de familia basado en DNI
    member.dni !== formData.head_of_family?.dni &&
    member.dni !== formData.head_of_family?.document_number
  )
  .map(member => ({...}));
```

**Intenci√≥n:** Evitar duplicar el jefe de familia (se env√≠a por separado en `head_of_family`)  
**Problema:** MongoDB termina sin el jefe de familia en `household_members`

---

## ‚úÖ Soluciones Propuestas

### **Soluci√≥n 1: Corregir Mapper - Restaurar household_members**

**Archivo:** `backend/src/mi_app_completa_backend/infrastructure/persistence/techo_propio/mappers/application_mapper.py`

**L√≠neas a modificar:** ~80-125

```python
@classmethod
def from_dict(cls, document: Dict[str, Any]) -> TechoPropioApplication:
    """Convertir documento MongoDB a entidad TechoPropioApplication"""
    try:
        # Usar mappers espec√≠ficos
        head_of_family = ApplicantMapper.from_dict(document["main_applicant"])
        property_info = PropertyMapper.from_dict(document["property_info"])
        head_of_family_economic = EconomicMapper.from_dict(document["main_applicant_economic"])
        
        # ‚úÖ CORREGIDO: Restaurar household_members desde MongoDB
        household_members = []
        if "household_members" in document and document["household_members"]:
            household_members = [
                HouseholdMemberMapper.from_dict(member_data)
                for member_data in document["household_members"]
            ]
        
        # Crear solicitud con todos los datos
        application = TechoPropioApplication(
            head_of_family=head_of_family,
            property_info=property_info,
            head_of_family_economic=head_of_family_economic,
            household_members=household_members  # ‚úÖ AGREGAR
        )
        
        # ... resto del c√≥digo
```

---

### **Soluci√≥n 2: Corregir Frontend - Mapeo de Respuesta**

**Archivo:** `frontend/src/modules/techo-propio/pages/EditApplication.tsx`

**L√≠neas a modificar:** ~38-90

```typescript
useEffect(() => {
  if (selectedApplication) {
    console.log('üîç selectedApplication:', selectedApplication);
    
    // ‚úÖ CORREGIDO: Buscar jefe de familia en TODOS los campos posibles
    const headOfFamily = 
      selectedApplication.head_of_family ||  // Backend nuevo
      selectedApplication.applicant ||  // Frontend espera
      selectedApplication.main_applicant;  // MongoDB antiguo
    
    console.log('üë®‚Äçüíº Jefe de Familia:', headOfFamily);
    
    // ‚úÖ CORREGIDO: Buscar en household_members como fallback
    let realHeadOfFamily = selectedApplication.household_members?.find(
      member => 
        member.member_type === 'JEFE_FAMILIA' ||
        member.relationship === 'jefe_familia' ||
        member.document_number === headOfFamily?.document_number
    );
    
    // Si no est√° en household_members, usar headOfFamily directamente
    if (!realHeadOfFamily && headOfFamily) {
      realHeadOfFamily = headOfFamily;
    }
    
    console.log('üë®‚Äçüíº Jefe de Familia Real:', realHeadOfFamily);
    
    const mappedData: ApplicationFormData = {
      head_of_family: {
        dni: realHeadOfFamily?.document_number || realHeadOfFamily?.dni || '',
        document_number: realHeadOfFamily?.document_number || realHeadOfFamily?.dni || '',
        first_name: realHeadOfFamily?.first_name || '',
        paternal_surname: realHeadOfFamily?.paternal_surname || '',
        maternal_surname: realHeadOfFamily?.maternal_surname || '',
        phone_number: realHeadOfFamily?.phone_number || '',
        email: realHeadOfFamily?.email || '',
        birth_date: realHeadOfFamily?.birth_date || '',
        civil_status: realHeadOfFamily?.civil_status || 'soltero',
        education_level: realHeadOfFamily?.education_level || 'secundaria_completa',
        occupation: realHeadOfFamily?.occupation || ''
      },
      household_members: selectedApplication.household_members || [],
      property_info: selectedApplication.property_info,
      comments: selectedApplication.comments || ''
    };
    
    console.log('üì¶ Mapped formData:', mappedData);
    setFormData(mappedData);
  }
}, [selectedApplication]);
```

---

### **Soluci√≥n 3: Corregir Interface TypeScript**

**Archivo:** `frontend/src/modules/techo-propio/types/application.types.ts`

**L√≠neas a modificar:** ~268-290

```typescript
export interface TechoPropioApplication {
  id?: string;
  code: string;
  status: ApplicationStatus;
  
  // ‚úÖ CORREGIDO: Soportar ambos nombres para compatibilidad
  applicant?: Applicant;  // Frontend antiguo
  head_of_family?: Applicant;  // Backend nuevo
  main_applicant?: Applicant;  // MongoDB antiguo
  
  household_members: HouseholdMember[];
  household_size: number;
  economic_info: EconomicInfo;
  head_of_family_economic?: EconomicInfo;  // ‚úÖ AGREGAR
  property_info: PropertyInfo;
  priority_score: number;
  documents: Document[];
  state_history: StateHistory[];
  comments?: string;
  created_at: string;
  updated_at: string;
  created_by?: string;
  updated_by?: string;
  
  // ‚úÖ AGREGAR: Campos de registro
  registration_date?: string;
  convocation_code?: string;
  registration_year?: number;
  sequential_number?: number;
  application_number?: string | null;
}
```

---

## üìä Plan de Implementaci√≥n

### **Paso 1: Corregir Backend (Mapper)**
1. Editar `application_mapper.py`
2. Agregar restauraci√≥n de `household_members` en `from_dict()`
3. Probar lectura de aplicaciones existentes

### **Paso 2: Corregir Frontend (EditApplication)**
1. Editar `EditApplication.tsx`
2. Agregar mapeo flexible de `head_of_family` / `applicant` / `main_applicant`
3. Usar `head_of_family` directamente si `household_members` est√° vac√≠o

### **Paso 3: Actualizar Interface TypeScript**
1. Editar `application.types.ts`
2. Agregar campos opcionales para compatibilidad
3. Documentar diferencias entre versiones

### **Paso 4: Migrar Datos Existentes (Opcional)**
1. Script de migraci√≥n para agregar jefe de familia a `household_members`
2. Renombrar `main_applicant` ‚Üí `head_of_family` en MongoDB

---

## üß™ Casos de Prueba

### **Test 1: Leer Aplicaci√≥n Existente**
```python
# backend/tests/test_edit_application.py
async def test_read_application_with_household():
    application = await repository.get_application_by_id("68ec37761afb62c361c3fc22")
    assert application.head_of_family is not None
    assert len(application.household_members) >= 0  # Puede estar vac√≠o en datos antiguos
```

### **Test 2: Frontend Carga Datos**
```typescript
// frontend/src/modules/techo-propio/__tests__/EditApplication.test.tsx
it('should load head_of_family from different field names', () => {
  const app1 = { head_of_family: { dni: '12345678' } };
  const app2 = { applicant: { dni: '87654321' } };
  const app3 = { main_applicant: { dni: '11111111' } };
  
  expect(getHeadOfFamily(app1).dni).toBe('12345678');
  expect(getHeadOfFamily(app2).dni).toBe('87654321');
  expect(getHeadOfFamily(app3).dni).toBe('11111111');
});
```

---

## üìù Conclusiones

### **Root Cause:**
1. ‚ùå **Mapper no restaura `household_members`** desde MongoDB
2. ‚ùå **Frontend busca `applicant`** pero backend env√≠a `head_of_family`
3. ‚ùå **Frontend filtra jefe de familia** de `household_members` al crear, pero no se reinserta

### **Impacto:**
- Al editar solicitudes, no aparecen miembros del hogar
- Jefe de familia no se puede editar
- Paso 2 y Paso 5 muestran datos vac√≠os

### **Soluci√≥n Recomendada:**
1. **Prioridad ALTA:** Corregir `application_mapper.py` para restaurar `household_members`
2. **Prioridad MEDIA:** Actualizar `EditApplication.tsx` para mapeo flexible
3. **Prioridad BAJA:** Actualizar interface TypeScript para claridad

---

**Estado:** üîç Diagn√≥stico Completo  
**Pr√≥ximo Paso:** Implementar Soluci√≥n 1 (Corregir Mapper)
